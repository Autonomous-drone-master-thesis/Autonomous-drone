name: Pylint

on:
  push:
    branches:
      - "*"

jobs:
  pylint:
    name: Pylint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install dependencies
        run: |
          pip install pylint pylint-json2html
        shell: bash
      - name: Run pylint
        id: pylint
        run: |
          pylint --output-format=json --score no ./**/*.py --good-names=x,y > pylint_report.json || true
          pylint_score=$(pylint --score y ./**/*.py --good-names=x,y || true)
        shell: bash
      - name: Convert Pylint output to HTML
        run: |
          pylint-json2html -f json -o pylint_report.html pylint_report.json
        shell: bash
      - name: Debug
        run: |
          echo "pylint_score = '${{ steps.pylint.outputs.pylint_score }}'"
        shell: bash
      - name: Upload Pylint report as an artifact
        uses: actions/upload-artifact@v2
        with:
          name: Pylint report
          path: pylint_report.html
      - name: Debug
        run: |
          pylint_score="${{ steps.pylint.outputs.pylint_score }}"
          score_regex='Your code has been rated at (-?[0-9]+\.[0-9]{2})/10'
          if [[ "${pylint_score}" =~ $score_regex ]]; then
            score="${BASH_REMATCH[1]}"
            echo "Pylint score: ${score} from ${pylint_score}"
          else
            echo "Unable to extract Pylint score from '${pylint_score}'"
          fi
        shell: bash
